const express = require("express");
const { exec } = require("child_process");
var engine = require("consolidate");
const path = require("path");
const fs = require("fs");
const opn = require("opn");

const port = 3000;
const app = express();

app.set("views", __dirname + "/views");
app.engine("html", engine.mustache);
app.set("view engine", "html");

var exeFile = process.argv[2];
// var exeFile = "";

// // Parse URL-encoded bodies (as sent by HTML forms)
// app.use(express.urlencoded());
// // Parse JSON bodies (as sent by API clients)
// app.use(express.json());
// // Access the parse results as request.body
// app.post("/fileName", function (request, response) {
//   exeFile = request.body.name;
// });

app.get("/data", (req, res) => {
  if (exeFile != null) {
    exec(`python code.py ${exeFile}`, (err, stprdout, stderr) => {
      if (err) {
        console.log("error");
        return;
      }

      const dataBuffer = fs.readFileSync("data.json");
      const data = JSON.parse(dataBuffer.toString());
      res.json(data);
    });
  } else {
    console.log("error");
        return;
  }
});

app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname + "/views/index.html"));
});

app.listen(port, function () {
  console.log(`Server listening on port ${port}`);
  opn("http://localhost:3000");
});
